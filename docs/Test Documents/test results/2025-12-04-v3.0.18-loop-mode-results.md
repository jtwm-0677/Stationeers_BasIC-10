# Test Results: v3.0.18 Simulator Loop Mode Fix

**Version:** 3.0.18
**Date:** 2025-12-04
**Tester:** Claude Code (QA Instance)
**Test Plan:** `2025-12-04-v3.0.18-loop-mode-fix.md`

---

## Executive Summary

| Category | Result |
|----------|--------|
| **Overall Status** | PARTIAL - Requires Manual UI Testing + Bug Fixes |
| **MCP Tests** | PASS (3/3) |
| **Manual UI Tests** | NOT TESTED (12 tests) |
| **Bugs Found** | 3 (1 High, 2 Medium) |

**Note:** The MCP tools do not include a `basic10_simulator_loop_start` command. Tests LOOP-01 through LOOP-13 require manual UI interaction with the Loop button. Only regression tests (LOOP-14, LOOP-15) and basic simulator functionality could be verified via MCP.

**Bugs Discovered:**
1. **HIGH:** NamedDeviceNode generates wrong syntax (missing `IC.Device[].Name[]` format)
2. **MEDIUM:** VS code generation order issues (Main label placement)
3. **MEDIUM:** VS IF block structure issues

---

## Test Environment

- **Test Method:** MCP Tools via Basic10.Mcp
- **Compiler Version:** v3.0.18 (assumed based on test plan)
- **Test Date:** 2025-12-04 19:00 UTC

---

## Test Script Used

```basic
REM Loop Mode Test Script
VAR count = 0

MainLoop:
    count = count + 1
    YIELD
    GOTO MainLoop
```

### Compiled IC10 Output (6 lines)
```ic10
move r0 0
MainLoop:
add r1 r0 1
move r0 r1
yield
j MainLoop
```

**Compilation:** PASS - Clean compile with no errors/warnings

---

## MCP Test Results

### LOOP-14: Run Button Regression
| Item | Result |
|------|--------|
| **Status** | PASS |
| **Objective** | Verify Run button unchanged - stops at YIELD without auto-resume |

**Test Execution:**
1. Reset simulator - PC: 0, Status: READY
2. Executed `basic10_simulator_run`
3. Result: PC: 5, Status: YIELDING, Instructions: 4
4. Verified state remained YIELDING (no auto-resume)
5. Manually stepped past yield, ran again
6. Result: PC: 5, Status: YIELDING, Instructions: 8, r0: 2.0

**Evidence:**
- Run stops at yield instruction (PC 5)
- Status correctly shows "YIELDING"
- No automatic resume after yield
- Manual intervention required to continue

---

### LOOP-15: Step Button Regression
| Item | Result |
|------|--------|
| **Status** | PASS |
| **Objective** | Verify Step button executes one instruction per click |

**Test Execution:**
| Step | PC Before | PC After | Instruction | Register Changes |
|------|-----------|----------|-------------|------------------|
| 1 | 0 | 1 | `move r0 0` | r0 = 0 |
| 2 | 1 | 2 | `MainLoop:` (label) | - |
| 3 | 2 | 3 | `add r1 r0 1` | r1 = 1 |
| 4 | 3 | 4 | `move r0 r1` | r0 = 1 |
| 5 | 4 | 5 | `yield` | Status: YIELDING |
| 6 | 5 | 1 | `j MainLoop` | - |
| 7 | 1 | 2 | `MainLoop:` | - |
| 8 | 2 | 3 | `add r1 r0 1` | r1 = 2 |

**Evidence:**
- Each step advances exactly one instruction
- PC increments correctly
- Jump instruction works (PC 5 â†’ 1)
- Registers update correctly

---

### LOOP-06: Variable Increments Across Loops (Partial via Step)
| Item | Result |
|------|--------|
| **Status** | PASS |
| **Objective** | Verify script state persists across loop iterations |

**Test Execution:**
- After first loop iteration: r0 = 1
- After step past yield + run to next yield: r0 = 2
- State persists correctly across yield boundaries

---

## Manual UI Tests Required

The following tests require manual UI interaction with the Simulator window's Loop button:

| Test ID | Test Name | Priority | Status |
|---------|-----------|----------|--------|
| LOOP-01 | Loop Button Visibility | High | NOT TESTED |
| LOOP-02 | Start Loop Mode | Critical | NOT TESTED |
| LOOP-03 | Yield Pause State | Critical | NOT TESTED |
| LOOP-04 | Auto-Resume After Yield | Critical | NOT TESTED |
| LOOP-05 | Loop Counter Increments | High | NOT TESTED |
| LOOP-07 | Stop Loop | High | NOT TESTED |
| LOOP-08 | Speed Slider Affects Yield Pause | Medium | NOT TESTED |
| LOOP-09 | Device Editing During Yield Pause | Medium | NOT TESTED |
| LOOP-10 | Reset During Loop | High | NOT TESTED |
| LOOP-11 | Stop Button During Loop | High | NOT TESTED |
| LOOP-12 | Close Window During Loop | Medium | NOT TESTED |
| LOOP-13 | Script Without Loop Structure | Medium | NOT TESTED |

### Manual Test Checklist

Please verify the following manually in the UI:

- [ ] **LOOP-01:** Purple Loop button visible between Reset and Speed slider
- [ ] **LOOP-02:** Clicking Loop shows "Looping" status and "Stop Loop" button text
- [ ] **LOOP-03:** Status shows "Looping (yield pause)" when at YIELD
- [ ] **LOOP-04:** Execution auto-resumes after yield pause delay
- [ ] **LOOP-05:** "Loops: N" counter increments in status bar
- [ ] **LOOP-07:** "Stop Loop" button stops execution and resets button text
- [ ] **LOOP-08:** Speed slider affects yield pause duration (min ~2000ms, max ~100ms)
- [ ] **LOOP-09:** Device grid editable during yield pause
- [ ] **LOOP-10:** Reset button stops loop and clears all state
- [ ] **LOOP-11:** Stop button halts loop and shows "Halted" status
- [ ] **LOOP-12:** Closing window during loop causes no errors/orphan timers
- [ ] **LOOP-13:** Script without GOTO stops gracefully after yield

---

## Known Issues Discovered During Testing

### CRITICAL: Simulator Window Does Not Auto-Update

**Issue:** The Simulator window does NOT automatically update when code changes are made in:
- The main compiler/editor interface
- The Visual Scripting interface

**Workaround:** The Simulator window must be **closed and reopened** for it to load the updated compiled code.

**Impact:** Users may test old code without realizing the simulator hasn't refreshed.

**Recommendation:** Add auto-refresh or a "Reload Code" button to the Simulator window.

---

### Visual Scripting Bugs

During testing, the following VS bugs were identified:

#### BUG: NamedDeviceNode Generates Wrong Syntax

**Severity:** High
**File:** `UI/VisualScripting/Nodes/NamedDeviceNode.cs`

**Current Behavior:**
The `GenerateCode()` method outputs:
```csharp
return $"DEVICE {AliasName} \"{PrefabName}\"";
```

Produces: `DEVICE OccupantSensorDuck "StructureOccupancySensor"`

**Expected Behavior:**
Should output the `IC.Device[].Name[]` syntax:
```csharp
return $"ALIAS {AliasName} = IC.Device[{PrefabName}].Name[\"{DeviceName}\"]";
```

Should produce: `ALIAS OccupantSensorDuck = IC.Device[StructureOccupancySensor].Name["Duck Office Occupied"]`

**Required Changes:**
1. Add a third property `DeviceName` (string) for the labeler name
2. Update `GetEditableProperties()` to include the new field
3. Update `GenerateCode()` to use the correct syntax
4. Update validation to require DeviceName

**Current Properties:**
- `AliasName`: Variable name to use in code (e.g., `OccupantSensorDuck`)
- `PrefabName`: Device type (e.g., `StructureOccupancySensor`)
- **MISSING:** `DeviceName`: Labeler name (e.g., `"Duck Office Occupied"`)

---

#### BUG: Code Generation Order Issues

The generated BASIC code sometimes places the Main label after the loop body instead of before it, causing incorrect program flow.

---

#### BUG: IF Block Structure

The True branch code may appear outside the IF block in generated code, causing logic errors.

---

## Recommendations

1. **Add MCP Loop Tools:** Consider adding `basic10_simulator_loop_start` and `basic10_simulator_loop_stop` MCP commands to enable automated testing of loop mode.

2. **Manual Testing Required:** Critical tests LOOP-02, LOOP-03, LOOP-04 must be manually verified before release sign-off.

3. **Regression Tests Pass:** Core simulator functionality (Run, Step) is unaffected by the loop mode changes.

4. **Simulator Auto-Refresh:** Implement automatic code reload in Simulator when source changes, or add manual refresh button.

5. **VS Named Device Support:** Add DeviceName property to NamedDevice nodes to support `IC.Device[type].Name["label"]` syntax.

---

## Conclusion

**MCP-testable functionality:** PASS
**Manual UI testing:** REQUIRED for full test coverage

The regression tests confirm that existing Run and Step functionality works correctly. The loop mode fix cannot be fully verified via MCP and requires manual UI testing of the Loop button in the Simulator window.

---

**End of Test Results**
