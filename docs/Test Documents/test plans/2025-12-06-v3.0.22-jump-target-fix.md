# Test Plan: v3.0.22 Jump Target Calculation Fix

**Date:** 2025-12-06
**Version:** v3.0.22
**Bug Fixed:** Critical jump target miscalculation in single-line IF statements with assignments

---

## Summary of Changes

Fixed the `ConvertLabelsToOffsets` method in `MipsGenerator.cs` to correctly calculate jump targets for IC10.

### Root Cause Identified

The compiler was incorrectly counting two types of lines as executable instructions:

1. **Comment lines** (lines starting with `#`) - IC10 ignores these
2. **User label lines** (lines like `Main:`) - IC10 treats labels as markers for the next instruction, not as separate lines

This caused jump targets to be calculated with an offset of +N lines, where N is the number of comments and user labels appearing before the target instruction.

### Fix Applied

Modified `ConvertLabelsToOffsets` (around line 206) to:
- Skip incrementing `instructionNumber` for comment lines
- Skip incrementing `instructionNumber` for user label lines (while still keeping them in output)

---

## Test Cases

### Test Case 1: Basic Single-Line IF with Assignment

**BASIC Code:**
```basic
var temp = 273
var lowThresh = 270
var highThresh = 275
var heatOn = 0

Main:
    IF temp < lowThresh THEN heatOn = 1
    IF temp > highThresh THEN heatOn = 0
    YIELD
    GOTO Main
END
```

**Expected IC10 Output:**
```
move r0 273       # Line 0: temp
move r1 270       # Line 1: lowThresh
move r2 275       # Line 2: highThresh
move r3 0         # Line 3: heatOn
Main:             # Label for line 4
bge r0 r1 X       # Line 4: first IF - X should be line of next instruction (6)
move r3 1         # Line 5: heatOn = 1
ble r0 r2 Y       # Line 6: second IF - Y should be line of next instruction (8)
move r3 0         # Line 7: heatOn = 0
yield             # Line 8
j Main            # Line 9
```

**Pass Criteria:**
- The first `bge` instruction jumps to the `ble` instruction, NOT past it
- The second `ble` instruction jumps to `yield`, NOT past the program end
- No jump targets point to `hcf` or beyond program boundaries

---

### Test Case 2: Full Climate Control Script (Original Bug Report)

**BASIC Code:**
```basic
ALIAS sensor = IC.Device[StructureGasSensor].Name["Interior Sensor"]
ALIAS heater = IC.Device[StructureWallHeater].Name["Heater"]
ALIAS tempDisplay = IC.Device[ModularDeviceLEDdisplay3].Name["Room Temperature"]

var temp = 0
var highThresh = 275.65
var lowThresh = 270.65
var heatOn = 0

Main:
    temp = sensor.Temperature.Average
    tempDisplay.Setting = temp

    IF temp < lowThresh THEN heatOn = 1
    IF temp > highThresh THEN heatOn = 0

    heater.On = heatOn
    YIELD
    GOTO Main
END
```

**Pass Criteria:**
- When temp < lowThresh (e.g., 267K): Heater turns ON
- When temp > highThresh (e.g., 280K): Heater turns OFF
- When lowThresh <= temp <= highThresh (e.g., 273K): Heater maintains previous state
- Program continues looping without halting

---

### Test Case 3: Single-Line IF with GOTO (Should Still Work)

**BASIC Code:**
```basic
var temp = 273
var lowThresh = 270

Main:
    IF temp < lowThresh THEN GOTO HeatOn
    GOTO Continue

HeatOn:
    YIELD
    GOTO Main

Continue:
    YIELD
    GOTO Main
END
```

**Pass Criteria:**
- User labels resolve correctly
- GOTO-based IF statements still function as before

---

### Test Case 4: Multi-Line IF Block (Should Still Work)

**BASIC Code:**
```basic
var temp = 273
var lowThresh = 270
var highThresh = 275
var heatOn = 0

Main:
    IF temp < lowThresh THEN
        heatOn = 1
    ELSEIF temp > highThresh THEN
        heatOn = 0
    ENDIF
    YIELD
    GOTO Main
END
```

**Pass Criteria:**
- Multi-line IF...ELSEIF...ENDIF blocks continue to work correctly
- No regression in existing functionality

---

## Verification Checklist

1. [ ] Compile test case 1 and verify jump targets in IC10 output
2. [ ] Test case 1 works correctly in simulator
3. [ ] Compile test case 2 (original bug report code)
4. [ ] Test case 2 works correctly in-game at different temperatures
5. [ ] Test case 3 (IF with GOTO) still works
6. [ ] Test case 4 (multi-line IF) still works
7. [ ] No regressions in other compiled scripts

---

## Files Modified

- `src/CodeGen/MipsGenerator.cs` - `ConvertLabelsToOffsets` method (lines 206-236)
- `BasicToMips.csproj` - Version bump to 3.0.22
