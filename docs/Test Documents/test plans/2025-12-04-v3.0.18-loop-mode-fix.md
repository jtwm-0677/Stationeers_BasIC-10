# Test Plan: v3.0.18 Simulator Loop Mode Fix

**Version:** 3.0.18
**Date:** 2025-12-04
**Author:** Claude Code (Development Instance)
**Feature:** Simulator Loop Mode Bug Fix

---

## Summary

This test plan covers the fix for the Simulator Loop Mode feature that was reported as non-functional in v3.0.17 QA testing. The Loop button previously behaved identically to the Run button - running until YIELD and stopping instead of auto-resuming.

---

## Changes Made

### Files Modified
- `UI/SimulatorWindow.xaml.cs`

### Technical Changes
1. **Removed `_loopTimer`** - The DispatcherTimer had no interval set, causing it to fire immediately (default interval = 0) and stop itself via `LoopTimer_Tick`, breaking yield pause state detection.

2. **Added `_isInYieldPause` boolean flag** - Replaced unreliable `_loopTimer.IsEnabled` check with explicit state tracking.

3. **Added `ConfigureAwait(true)`** - Ensures async continuation in `ScheduleLoopResume()` runs on UI thread.

4. **Updated state management** - All methods that previously called `_loopTimer.Stop()` now set `_isInYieldPause = false` instead.

---

## Test Environment

- **OS:** Windows 10/11 x64
- **Runtime:** .NET 8.0
- **Application:** Basic_10.exe v3.0.18

---

## Pre-Test Setup

1. Launch Basic_10.exe
2. Create or load a test script with YIELD in a loop structure
3. Compile the script (F5 or Build menu)
4. Open Simulator (Build â†’ Simulate or F9)

### Test Script (Recommended)
```basic
' Loop Mode Test Script
VAR count = 0

MainLoop:
    count = count + 1
    YIELD
    GOTO MainLoop
```

Expected IC10 output:
```
move r0 0
loop:
add r0 r0 1
yield
j loop
```

---

## Test Cases

### LOOP-01: Loop Button Visibility
| Item | Value |
|------|-------|
| **Objective** | Verify Loop button is visible and correctly styled |
| **Steps** | 1. Open Simulator window |
| **Expected** | Purple Loop button visible in toolbar between Reset and Speed slider |
| **Priority** | High |

---

### LOOP-02: Start Loop Mode
| Item | Value |
|------|-------|
| **Objective** | Verify clicking Loop starts continuous execution |
| **Steps** | 1. Load test script<br>2. Click Loop button |
| **Expected** | - Status shows "Looping" (purple text)<br>- Button text changes to "Stop Loop"<br>- Execution begins |
| **Priority** | Critical |

---

### LOOP-03: Yield Pause State
| Item | Value |
|------|-------|
| **Objective** | Verify yield pause is detected and displayed |
| **Steps** | 1. Start Loop mode<br>2. Wait for YIELD instruction |
| **Expected** | - Status shows "Looping (yield pause)" briefly<br>- Execution pauses at YIELD |
| **Priority** | Critical |

---

### LOOP-04: Auto-Resume After Yield
| Item | Value |
|------|-------|
| **Objective** | Verify execution automatically resumes after yield pause |
| **Steps** | 1. Start Loop mode<br>2. Observe behavior after YIELD |
| **Expected** | - After pause delay, execution resumes<br>- Status returns to "Looping"<br>- PC advances past YIELD |
| **Priority** | Critical |

---

### LOOP-05: Loop Counter Increments
| Item | Value |
|------|-------|
| **Objective** | Verify loop counter displays and increments |
| **Steps** | 1. Start Loop mode<br>2. Let it run through multiple yield cycles |
| **Expected** | - "Loops: N" appears in status bar<br>- Counter increments each yield cycle |
| **Priority** | High |

---

### LOOP-06: Variable Increments Across Loops
| Item | Value |
|------|-------|
| **Objective** | Verify script state persists across loop iterations |
| **Steps** | 1. Use test script with counter<br>2. Start Loop mode<br>3. Observe r0 register |
| **Expected** | - r0 increments each loop iteration (1, 2, 3, ...)<br>- Value persists across YIELD |
| **Priority** | Critical |

---

### LOOP-07: Stop Loop
| Item | Value |
|------|-------|
| **Objective** | Verify Loop can be stopped |
| **Steps** | 1. Start Loop mode<br>2. Click "Stop Loop" button |
| **Expected** | - Execution stops<br>- Status shows "Paused" or current state<br>- Button returns to "Loop" |
| **Priority** | High |

---

### LOOP-08: Speed Slider Affects Yield Pause
| Item | Value |
|------|-------|
| **Objective** | Verify speed slider adjusts yield pause duration |
| **Steps** | 1. Set speed slider to minimum (1)<br>2. Start Loop, observe pause duration<br>3. Set speed slider to maximum (100)<br>4. Observe pause duration |
| **Expected** | - Low speed = longer pause (~2000ms)<br>- High speed = shorter pause (~100ms) |
| **Priority** | Medium |

---

### LOOP-09: Device Editing During Yield Pause
| Item | Value |
|------|-------|
| **Objective** | Verify device values can be edited during yield pause |
| **Steps** | 1. Start Loop mode with script that reads device<br>2. During yield pause, edit device property in grid<br>3. Let execution resume |
| **Expected** | - Device grid is editable during pause<br>- Changed values are reflected in next iteration |
| **Priority** | Medium |

---

### LOOP-10: Reset During Loop
| Item | Value |
|------|-------|
| **Objective** | Verify Reset button works during loop |
| **Steps** | 1. Start Loop mode<br>2. Click Reset button |
| **Expected** | - Loop stops<br>- PC resets to 0<br>- Registers cleared<br>- Loop counter resets to 0 |
| **Priority** | High |

---

### LOOP-11: Stop Button During Loop
| Item | Value |
|------|-------|
| **Objective** | Verify Stop button halts loop execution |
| **Steps** | 1. Start Loop mode<br>2. Click Stop button |
| **Expected** | - Loop stops immediately<br>- Status shows "Halted"<br>- Loop mode disabled |
| **Priority** | High |

---

### LOOP-12: Close Window During Loop
| Item | Value |
|------|-------|
| **Objective** | Verify closing window stops loop cleanly |
| **Steps** | 1. Start Loop mode<br>2. Close Simulator window |
| **Expected** | - Window closes without error<br>- No background timers continue |
| **Priority** | Medium |

---

### LOOP-13: Script Without Loop Structure
| Item | Value |
|------|-------|
| **Objective** | Verify behavior when script has no jump back |
| **Script** | `add r0 r0 1`<br>`yield` |
| **Steps** | 1. Load script without GOTO<br>2. Start Loop mode |
| **Expected** | - Runs once<br>- Halts after YIELD (PC past end)<br>- Loop mode stops automatically |
| **Priority** | Medium |

---

### LOOP-14: Run Button Still Works
| Item | Value |
|------|-------|
| **Objective** | Regression - verify Run button unchanged |
| **Steps** | 1. Click Run (not Loop)<br>2. Wait for YIELD |
| **Expected** | - Runs until YIELD<br>- Stops at YIELD (no auto-resume)<br>- Status shows "Yielding" |
| **Priority** | High |

---

### LOOP-15: Step Button Still Works
| Item | Value |
|------|-------|
| **Objective** | Regression - verify Step button unchanged |
| **Steps** | 1. Click Step multiple times |
| **Expected** | - Executes one instruction per click<br>- Works normally |
| **Priority** | High |

---

## Status Display Matrix

| State | Expected Status Text | Text Color |
|-------|---------------------|------------|
| Loop running | "Looping" | Purple (#C586C0) |
| Loop at yield pause | "Looping (yield pause)" | Purple (#C586C0) |
| Run mode at yield | "Yielding" | Light Yellow |
| Running (non-loop) | "Running" | Light Green |
| Paused | "Paused" | White |
| Halted | "Halted" | White |
| Error | "Error" | Light Coral |

---

## Pass/Fail Criteria

### Pass
- All Critical priority tests pass
- All High priority tests pass
- No regressions in existing functionality

### Conditional Pass
- All Critical tests pass
- Minor issues in Medium priority tests (documented for future fix)

### Fail
- Any Critical test fails
- Multiple High priority tests fail
- Regressions in Run/Step functionality

---

## Notes for QA Tester

1. **Speed Slider Default:** Value is 50, which gives ~1100ms yield pause
2. **Loop Counter:** Only visible when looping or after loop has run
3. **MCP Testing:** If testing via MCP, ensure `basic10_simulator_loop_start` command exists (may not be implemented yet)
4. **Manual Testing Preferred:** Click the actual Loop button in UI for accurate testing

---

## Related Documents

- **Previous Test Results:** `../test results/2025-12-04-v3.0.17-results.md`
- **Feature Plan:** `../../plans/2025-12-04-visual-scripting-phase2.md` (Feature 4)

---

**End of Test Plan**
