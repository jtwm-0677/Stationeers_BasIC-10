# Test Plan: v3.0.19 Bug Fixes

**Version:** 3.0.19
**Date:** 2025-12-04
**Author:** Claude Code (Development Instance)
**Features:** Bug fixes for default script, Visual Scripting code generation, and error reporting

---

## Summary

This release addresses multiple bugs discovered during v3.0.18 testing:
1. Default script syntax error (missing ENDIF)
2. NamedDeviceNode generating wrong syntax
3. VS code generation order issues (Main label placement)
4. VS IF block structure issues
5. Error reporter pointing to EOF instead of actual error line

---

## Changes Made

### 1. Default Script Fix
**File:** `UI/MainWindow.xaml.cs`
- Fixed missing `ENDIF` in nested IF statement on line 842
- Before: `IF status > 0 THEN status = 1`
- After: `IF status > 0 THEN status = 1 ENDIF`

### 2. NamedDeviceNode Syntax Fix
**Files:**
- `UI/VisualScripting/Nodes/NamedDeviceNode.cs`
- `UI/VisualScripting/CodeGen/GraphToBasicGenerator.cs`

**Changes:**
- Added `DeviceName` property for the in-game labeler name
- Updated node to have three editable properties: Alias Name, Device Type, Device Label
- Fixed code generation to output: `ALIAS name = IC.Device[type].Name["label"]`
- Before: `DEVICE myDevice "StructureActiveVent"`
- After: `ALIAS myDevice = IC.Device[StructureActiveVent].Name["Main Vent"]`

### 3. VS Code Generation Order Fix
**File:** `UI/VisualScripting/CodeGen/GraphToBasicGenerator.cs`

**Changes:**
- Added `Main:` label after section header for program entry point
- Removed Y-position sorting for execution flow (was causing IF branches to appear outside IF blocks)
- Now follows execution chains in proper order
- Comments are still sorted by Y-position at the top

### 4. VS IF Block Structure Fix
**File:** `UI/VisualScripting/CodeGen/GraphToBasicGenerator.cs`

**Root Cause:** Y-position sorting caused nodes connected to IF branches to be generated outside the IF block when positioned above the IF node.

**Fix:**
- Code now follows execution chains directly without Y-sorting
- Added `IsConnected` check for True pin before generating branch

### 5. Error Reporter Fix
**File:** `src/Parser/Parser.cs`

**Changes:**
- Error messages now report the line where the IF statement started, not EOF
- Before: "Expected ENDIF to close multi-line IF statement, got Eof" at line 999 (EOF)
- After: "Missing ENDIF for IF statement at line 60" at line 60

---

## Test Environment

- **OS:** Windows 10/11 x64
- **Runtime:** .NET 8.0
- **Application:** Basic_10.exe v3.0.19

---

## Test Cases

### DEFAULT-01: Default Script Compiles
| Item | Value |
|------|-------|
| **Objective** | Verify default script compiles without errors |
| **Steps** | 1. Launch Basic_10.exe fresh<br>2. Press F5 to compile default script |
| **Expected** | - Compiles successfully<br>- No errors shown<br>- IC10 code generated |
| **Priority** | Critical |

---

### DEFAULT-02: Default Script Runs in Simulator
| Item | Value |
|------|-------|
| **Objective** | Verify default script executes in simulator |
| **Steps** | 1. Compile default script<br>2. Open Simulator (F9)<br>3. Click Run |
| **Expected** | - Executes without errors<br>- Loops at YIELD instruction |
| **Priority** | High |

---

### VS-DEVICE-01: NamedDevice Node Properties
| Item | Value |
|------|-------|
| **Objective** | Verify NamedDevice node has three editable properties |
| **Steps** | 1. Open Visual Scripting<br>2. Add a NamedDevice node<br>3. Check properties panel |
| **Expected** | - Alias Name field<br>- Device Type field<br>- Device Label field |
| **Priority** | High |

---

### VS-DEVICE-02: NamedDevice Code Generation
| Item | Value |
|------|-------|
| **Objective** | Verify NamedDevice generates correct syntax |
| **Steps** | 1. Add NamedDevice node<br>2. Set: Alias="myVent", Type="StructureActiveVent", Label="Main Vent"<br>3. Check generated code |
| **Expected** | `ALIAS myVent = IC.Device[StructureActiveVent].Name["Main Vent"]` |
| **Priority** | Critical |

---

### VS-MAIN-01: Main Label Generated
| Item | Value |
|------|-------|
| **Objective** | Verify Main: label is generated in VS output |
| **Steps** | 1. Create simple VS program with Entry Point<br>2. Check generated BASIC code |
| **Expected** | - Section header "# --- Main ---"<br>- `Main:` label on next line |
| **Priority** | High |

---

### VS-IF-01: IF Block Structure Correct
| Item | Value |
|------|-------|
| **Objective** | Verify IF branches are generated inside IF block |
| **Steps** | 1. Create IF node with True branch connected<br>2. Position True branch node ABOVE IF node<br>3. Check generated code |
| **Expected** | - True branch code appears INSIDE IF...ENDIF block<br>- Not before the IF statement |
| **Priority** | Critical |

---

### VS-IF-02: Nested IF Structure
| Item | Value |
|------|-------|
| **Objective** | Verify nested IF statements generate correctly |
| **Steps** | 1. Create IF node<br>2. Connect another IF node to True branch<br>3. Check generated code |
| **Expected** | - Proper nesting with indentation<br>- All ENDIF statements present |
| **Priority** | High |

---

### VS-IF-03: IF with ELSE Branch
| Item | Value |
|------|-------|
| **Objective** | Verify IF with ELSE generates correctly |
| **Steps** | 1. Create IF node<br>2. Connect nodes to both True and False branches<br>3. Check generated code |
| **Expected** | - IF...THEN<br>- True branch code<br>- ELSE<br>- False branch code<br>- ENDIF |
| **Priority** | High |

---

### ERR-01: Missing ENDIF Reports Correct Line
| Item | Value |
|------|-------|
| **Objective** | Verify parser error points to IF statement line |
| **Test Script** | `IF x > 0 THEN`<br>`  y = 1`<br>`REM no ENDIF` |
| **Steps** | 1. Enter test script<br>2. Compile |
| **Expected** | Error: "Missing ENDIF for IF statement at line 1" pointing to line 1 |
| **Priority** | Critical |

---

### ERR-02: Nested Missing ENDIF
| Item | Value |
|------|-------|
| **Objective** | Verify error reports correct line for nested IF |
| **Test Script** | `IF x > 0 THEN`<br>`  IF y > 0 THEN`<br>`    z = 1`<br>`  ENDIF`<br>`REM outer missing ENDIF` |
| **Steps** | 1. Enter test script<br>2. Compile |
| **Expected** | Error points to line 1 (outer IF) |
| **Priority** | High |

---

### ERR-03: Missing ENDIF in ELSEIF
| Item | Value |
|------|-------|
| **Objective** | Verify error reports IF start line for ELSEIF missing ENDIF |
| **Test Script** | `IF x = 1 THEN`<br>`  a = 1`<br>`ELSEIF x = 2 THEN`<br>`  b = 2`<br>`REM missing ENDIF` |
| **Steps** | 1. Enter test script<br>2. Compile |
| **Expected** | Error references line 1 (IF start) |
| **Priority** | Medium |

---

### LOOP-REGRESSION: Simulator Loop Mode
| Item | Value |
|------|-------|
| **Objective** | Regression - verify Loop mode still works (from v3.0.18) |
| **Steps** | 1. Create looping script with YIELD<br>2. Compile<br>3. Open Simulator<br>4. Click Loop |
| **Expected** | - Continuous execution<br>- Auto-resume after YIELD<br>- "Looping" status shown |
| **Priority** | High |

---

## Pass/Fail Criteria

### Pass
- All Critical priority tests pass
- All High priority tests pass
- No regressions from v3.0.18

### Conditional Pass
- All Critical tests pass
- Minor issues in Medium priority tests (documented for future fix)

### Fail
- Any Critical test fails
- Multiple High priority tests fail
- Loop mode regression

---

## Related Documents

- **Previous Test Plan:** `2025-12-04-v3.0.18-loop-mode-fix.md`
- **Previous Test Results:** `../test results/2025-12-04-v3.0.18-loop-mode-results.md`

---

**End of Test Plan**
