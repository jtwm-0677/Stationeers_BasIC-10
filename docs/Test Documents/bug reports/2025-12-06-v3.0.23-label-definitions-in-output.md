# Bug Report: User Label Definitions in IC10 Output Cause Script Failure

**Version:** v3.0.23
**Date:** 2025-12-06
**Severity:** Critical - Scripts with user labels do not run
**Status:** NOT FIXED

---

## Summary

When BASIC code uses user-defined labels (like `Main:`, `DoCooling:`), the compiled IC10 output includes these label definitions. While jump instructions now correctly use numeric addresses (fixed in v3.0.23), the presence of the label definition lines themselves causes the script to not run in-game.

---

## Symptoms

- Script compiles without errors
- IC10 output matches in-game display exactly
- No errors shown in-game
- Script does not execute (display doesn't update, devices not controlled)
- Everything appears frozen

---

## Working vs Non-Working Output

### Non-Working (GOTO with labels):

```ic10
move r0 0
move r1 0
...
Main:                          <-- PROBLEM: Label definition in output
lbn r0 -1252983604 ...
...
bne r5 1 13
j 18                           <-- Jump is numeric (correct)
...
DoCooling:                     <-- PROBLEM: Label definition in output
sbn -321403609 ...
...
j 31                           <-- Jump is numeric (correct)
...
j 8                            <-- Jump is numeric (correct)
hcf
```

**Result:** Script does not run. Display frozen, devices unresponsive.

### Working (WHILE TRUE, no labels):

```ic10
move r0 0
move r1 0
...
beqz 1 35
lbn r0 -1252983604 ...
...
bne r5 1 19
sbn -321403609 ...
...
j 28                           <-- Numeric jump
...
j 7                            <-- Numeric jump
hcf
```

**Result:** Script runs correctly. Display updates, devices respond.

---

## Root Cause

The v3.0.23 fix correctly converts jump REFERENCES to numeric addresses, but still outputs the label DEFINITIONS (like `Main:`) in the IC10 code.

IC10 in Stationeers appears to not handle these label definition lines correctly, causing the script to fail silently.

---

## Expected Fix

Label definitions should be stripped from the final IC10 output entirely. They serve no purpose once all jumps are converted to numeric addresses.

**Before (buggy):**
```ic10
Main:
lbn r0 ...
```

**After (fixed):**
```ic10
lbn r0 ...
```

The label definitions can remain in BASIC source and be used during compilation for calculating jump targets, but should not appear in the final IC10 output.

---

## Test Case

**BASIC Code:**
```basic
var x = 0

Main:
    x = x + 1
    IF x > 10 THEN x = 0
    YIELD
    GOTO Main
END
```

**Current Output (broken):**
```ic10
move r0 0
Main:              <-- Should be removed
add r0 r0 1
ble r0 10 4
move r0 0
yield
j 1
hcf
```

**Expected Output (fixed):**
```ic10
move r0 0
add r0 r0 1
ble r0 10 4
move r0 0
yield
j 1
hcf
```

---

## Workaround

Use `WHILE TRUE...WEND` instead of `GOTO label`:

```basic
var x = 0

WHILE TRUE
    x = x + 1
    IF x > 10 THEN x = 0
    YIELD
WEND
END
```

This generates output without label definitions and works correctly.

---

## Files to Investigate

`src/CodeGen/MipsGenerator.cs`:
- Look for where label definitions are emitted to output
- After converting jump references to numeric, strip the label definition lines
- Or emit label definitions as comments (# Main:) if readability is desired

---

## Verification Checklist

1. [ ] Compile BASIC code with `GOTO Main` pattern
2. [ ] Verify no `Main:` or other user labels appear in IC10 output
3. [ ] Test in-game that script runs correctly
4. [ ] Verify WHILE TRUE pattern still works (regression check)
