# Comprehensive Bug Report: Single-Line IF Statement Jump Target Miscalculation

**Version Tested:** v3.0.21
**Date:** 2025-12-06
**Severity:** Critical - Causes program malfunction
**Status:** NOT FIXED in v3.0.21

---

## Bug Summary

Single-line IF statements with assignments (not GOTOs) generate incorrect branch target addresses. The skip targets are consistently **4 lines too high**, causing the program to skip over intended code or jump beyond the program entirely.

---

## Test Code (BASIC)

```basic
ALIAS sensor = IC.Device[StructureGasSensor].Name["Interior Sensor"]
ALIAS heater = IC.Device[StructureWallHeater].Name["Heater"]
ALIAS tempDisplay = IC.Device[ModularDeviceLEDdisplay3].Name["Room Temperature"]

var temp = 0
var highThresh = 275.65
var lowThresh = 270.65
var heatOn = 0

Main:
    temp = sensor.Temperature.Average
    tempDisplay.Setting = temp

    IF temp < lowThresh THEN heatOn = 1
    IF temp > highThresh THEN heatOn = 0

    heater.On = heatOn
    YIELD
    GOTO Main
END
```

---

## Compiled IC10 Output (v3.0.21)

Full output with line numbers:
```
Line 0:  move r0 0
Line 1:  move r1 0
Line 2:  move r2 275.65
Line 3:  move r3 270.65
Line 4:  move r4 0
Line 5:  move r5 0
Line 6:  move r6 0
Line 7:  lbn r0 -1252983604 -974770433 Temperature 0    [Main:]
Line 8:  lbn r1 435685051 1153460988 Pressure 0
Line 9:  sbn -246585138 1829138044 Setting r0
...
Line 30: bge r0 r3 36    [DoHeating:]  <-- PROBLEM
Line 31: move r6 1
Line 32: ble r0 r2 38                   <-- PROBLEM
Line 33: move r6 0
Line 34: sbn 24258244 1979190919 On r6
Line 35: yield
Line 36: j Main
Line 37: hcf
```

Total: 38 executable instructions (lines 0-37)

---

## Detailed Analysis of the Bug

### First IF Statement: `IF temp < lowThresh THEN heatOn = 1`

**Compiled to:**
```
Line 30: bge r0 r3 36    # if temp >= lowThresh, jump to 36
Line 31: move r6 1       # heatOn = 1
Line 32: ble r0 r2 38    # (next IF starts here)
```

**What happens:**
- Condition: `temp < lowThresh` → Inverted to `bge` (branch if greater or equal)
- Jump target: **36** (`j Main`)

**What SHOULD happen:**
- If `temp >= lowThresh`, skip the `move r6 1` and continue to next statement
- Jump target should be: **32** (`ble r0 r2 ...` - the next IF)

**Error:** Target is 36 instead of 32 = **+4 lines off**

---

### Second IF Statement: `IF temp > highThresh THEN heatOn = 0`

**Compiled to:**
```
Line 32: ble r0 r2 38    # if temp <= highThresh, jump to 38
Line 33: move r6 0       # heatOn = 0
Line 34: sbn ... On r6   # (next statement - heater.On = heatOn)
```

**What happens:**
- Condition: `temp > highThresh` → Inverted to `ble` (branch if less or equal)
- Jump target: **38** (BEYOND the program - line 37 is `hcf`)

**What SHOULD happen:**
- If `temp <= highThresh`, skip the `move r6 0` and continue to `heater.On = heatOn`
- Jump target should be: **34** (`sbn ... On r6`)

**Error:** Target is 38 instead of 34 = **+4 lines off**

---

## Observed Behavior vs Expected Behavior

### Test Conditions
- Room temperature: 273.6K (between lowThresh 270.65K and highThresh 275.65K)
- Expected: Heater should maintain previous state (hysteresis behavior)

### What Happens (BUGGY)

1. `temp = 273.6K`
2. First IF: `273.6 < 270.65`? FALSE
   - `bge r0 r3 36` → 273.6 >= 270.65? TRUE → Jump to line 36
   - **Jumps to `j Main`**, skipping:
     - `move r6 1` (correct skip)
     - `ble r0 r2 38` (WRONG - skipped)
     - `move r6 0` (WRONG - skipped)
     - `sbn ... On r6` (WRONG - skipped!)
   - **Heater never gets set!**

3. Second IF: Never reached because we jumped past it

4. Result: `heater.On = heatOn` never executes, heater stays off

### What SHOULD Happen

1. `temp = 273.6K`
2. First IF: `273.6 < 270.65`? FALSE
   - `bge r0 r3 32` → 273.6 >= 270.65? TRUE → Jump to line 32
   - Correctly skips only `move r6 1`
   - Continues to line 32 (second IF)

3. Second IF: `273.6 > 275.65`? FALSE
   - `ble r0 r2 34` → 273.6 <= 275.65? TRUE → Jump to line 34
   - Correctly skips only `move r6 0`
   - Continues to line 34 (`sbn ... On r6`)

4. `heater.On = heatOn` executes with preserved state
5. Result: Heater maintains its previous on/off state (correct hysteresis)

---

## Pattern Identified

| IF Statement | Expected Target | Actual Target | Difference |
|--------------|-----------------|---------------|------------|
| First IF     | 32              | 36            | +4         |
| Second IF    | 34              | 38            | +4         |

**The skip target is consistently 4 lines too high.**

---

## Working Workaround

Using `IF...THEN GOTO label` instead of `IF...THEN assignment` works correctly:

```basic
DoHeating:
    IF temp < lowThresh THEN GOTO HeatOn
    IF temp > highThresh THEN GOTO HeatOff
    GOTO ApplyHeat

HeatOn:
    heatOn = 1
    GOTO ApplyHeat

HeatOff:
    heatOn = 0
    GOTO ApplyHeat

ApplyHeat:
    heater.On = heatOn
```

This suggests the bug is specifically in calculating the **implicit skip target** for single-line IF statements with assignments, not in label resolution for explicit GOTOs.

---

## Hypothesis: Root Cause

The compiler appears to be including something in its line count that shouldn't be there when calculating skip targets. Possibilities:

1. **Labels are being counted as lines** - Each label (Main:, DoHeating:, etc.) adds to the count
2. **Comments in output are affecting calculation** - The `# comment` lines are being counted
3. **Off-by-N error in skip calculation** - The formula for "skip past this statement" is adding extra offset
4. **Different counting between emission and target calculation** - The line counter used during code emission differs from the one used for branch targets

The consistent +4 offset suggests 4 extra "things" are being counted somewhere.

---

## Files to Investigate

- `src/CodeGen/MipsGenerator.cs` - Look for:
  - Single-line IF statement handling
  - How the "skip target" is calculated for `IF...THEN statement`
  - Label handling during line counting
  - Difference between `IF...THEN GOTO` vs `IF...THEN assignment` code paths

---

## Test Environment

- Compiler Version: v3.0.21
- Test Date: 2025-12-06
- MCP Connection: Verified reconnected to correct instance
- Script used: Climate Control (full script in editor)
- In-game test: Temperature 273.6K, heater would not turn on or stay on

---

## Verification Checklist for Fix

1. [ ] Compile the test code above
2. [ ] Verify `bge r0 r3 X` where X = line of next IF (not +4)
3. [ ] Verify `ble r0 r2 Y` where Y = line of `sbn` (not +4)
4. [ ] Test in-game: heater should turn ON when temp < 270.65K
5. [ ] Test in-game: heater should turn OFF when temp > 275.65K
6. [ ] Test in-game: heater should MAINTAIN state when 270.65K < temp < 275.65K
