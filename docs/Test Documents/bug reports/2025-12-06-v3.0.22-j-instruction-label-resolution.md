# Bug Report: Unconditional Jump (j) Instructions Not Resolving Labels to Numeric Addresses

**Version:** v3.0.22 (fix for comment/label counting)
**Date:** 2025-12-06
**Severity:** Critical - Scripts with GOTO/labels do not run
**Status:** Regression introduced by v3.0.22 fix

---

## Summary

The fix for the branch target miscalculation (counting comments/labels as executable lines) broke label resolution for unconditional `j` (jump) instructions. Conditional branches (`bne`, `bge`, `ble`, etc.) correctly show numeric addresses, but `j` instructions emit label names which IC10 does not recognize.

---

## Symptoms

- Script compiles without errors
- IC10 output shows `j LabelName` instead of `j 17` (numeric address)
- In-game IC10 chip shows label names in code
- Script does not run - display freezes, devices turn on/off once then stop responding
- Devices can be manually toggled and stay in that state (script not controlling them)

---

## Compiled Output Showing the Bug

```ic10
move r0 0
move r1 0
...
bne r4 1 12          <-- Conditional branch: numeric target ✓
j DoCooling          <-- Unconditional jump: LABEL NAME ✗
bne r5 1 14          <-- Conditional branch: numeric target ✓
j DoPurging          <-- Unconditional jump: LABEL NAME ✗
ble r0 r2 16         <-- Conditional branch: numeric target ✓
move r4 1
j DoHeating          <-- Unconditional jump: LABEL NAME ✗
DoCooling:
sbn -321403609 -1128025635 On 1
...
j DoHeating          <-- Unconditional jump: LABEL NAME ✗
DoPurging:
...
j DoHeating          <-- Unconditional jump: LABEL NAME ✗
DoHeating:
...
j Main               <-- Unconditional jump: LABEL NAME ✗
hcf
```

---

## Expected Output

All jump instructions should have numeric addresses:

```ic10
bne r4 1 12          <-- ✓
j 17                 <-- Should be numeric, not "j DoCooling"
bne r5 1 14          <-- ✓
j 24                 <-- Should be numeric, not "j DoPurging"
...
j 30                 <-- Should be numeric, not "j DoHeating"
...
j 7                  <-- Should be numeric, not "j Main"
```

---

## Root Cause Analysis

The v3.0.22 fix modified `ConvertLabelsToOffsets` in `MipsGenerator.cs` to correctly exclude comments and labels when calculating branch targets. However, it appears that:

1. **Conditional branches** (`bne`, `bge`, `ble`, `blt`, `bgt`, `beq`, etc.) - Label resolution works correctly, numeric addresses emitted

2. **Unconditional jumps** (`j`) - Label resolution NOT working, label names emitted as-is

The fix likely affected only the conditional branch code path, leaving the unconditional `j` instruction handling unchanged or broken.

---

## Test Case

**BASIC Code:**
```basic
var x = 0

Main:
    x = x + 1
    IF x > 10 THEN GOTO Reset
    GOTO Main

Reset:
    x = 0
    GOTO Main
END
```

**Expected IC10:**
```ic10
move r0 0
Main:
add r0 r0 1
ble r0 10 5
j 6           <-- Should be numeric
j 0           <-- Should be numeric
Reset:
move r0 0
j 0           <-- Should be numeric
hcf
```

**Actual IC10 (buggy):**
```ic10
move r0 0
Main:
add r0 r0 1
ble r0 10 5     <-- Conditional: correct numeric
j Reset         <-- WRONG: label name instead of number
j Main          <-- WRONG: label name instead of number
Reset:
move r0 0
j Main          <-- WRONG: label name instead of number
hcf
```

---

## Workaround

Use `WHILE TRUE...WEND` instead of `GOTO label`:

```basic
WHILE TRUE
    ' code here
    YIELD
WEND
```

This compiles to:
```ic10
beqz 1 35       <-- Conditional: numeric ✓
...
j 7             <-- Generated by WEND: numeric ✓
```

The `WEND` generates a correct numeric `j` instruction.

---

## Files to Investigate

`src/CodeGen/MipsGenerator.cs`:
- Look for where `j` instructions are emitted
- Compare to how conditional branch targets are resolved
- The fix for conditional branches needs to also apply to unconditional jumps
- Check `ConvertLabelsToOffsets` - may need to handle `j label` the same way as `bne r0 r1 label`

---

## Verification Checklist

1. [ ] Compile test case with `GOTO label`
2. [ ] Verify `j` instructions show numeric addresses, not label names
3. [ ] Test in-game that script with GOTO actually runs
4. [ ] Verify conditional branches still work correctly (no regression)
