# QA Test Plan: v3.0.15 Simulator Batch Instructions

**Version:** 3.0.15
**Date:** 2025-12-04
**Focus:** Simulator support for DEVICE statements via lb/sb batch instructions

---

## Background

DEVICE statements in BASIC compile to batch instructions (`lb`/`sb`) that operate on devices by prefab hash, not pin-based `l`/`s` instructions. v3.0.15 adds the missing `lb` and `sb` handlers to the simulator.

**Instruction Formats:**
- `lb result HASH Property Mode` - Load batch (read from devices by hash)
- `sb HASH Property value` - Store batch (write to devices by hash)

---

## Test Suite

### 1. Basic DEVICE Read/Write

| Test ID | Test Case | Steps | Expected Result |
|---------|-----------|-------|-----------------|
| DEV-01 | DEVICE registration | Compile script with `DEVICE sensor "StructureGasSensor"` | No errors, IC10 shows `# DEVICE sensor "StructureGasSensor"` comment |
| DEV-02 | Named device in simulator | Start simulator after compiling | `sensor` appears in device list (separate from d0-d5) |
| DEV-03 | Read via DEVICE | Set `sensor.Temperature = 350` in simulator, step through `temp = sensor.Temperature` | `temp` variable receives value 350 |
| DEV-04 | Write via DEVICE | Step through `sensor.On = 1` | `sensor.On` shows 1 in device list |
| DEV-05 | Multiple devices | Script with `DEVICE sensor "..."` and `DEVICE cooler "..."` | Both appear in device list, operate independently |

**Test Script:**
```basic
DEVICE sensor "StructureGasSensor"
VAR temp = 0

MainLoop:
    temp = sensor.Temperature
    IF temp > 295 THEN
        sensor.On = 1
    ELSE
        sensor.On = 0
    ENDIF
    YIELD
    GOTO MainLoop
```

---

### 2. Temperature Control Script (Integration)

| Test ID | Test Case | Steps | Expected Result |
|---------|-----------|-------|-----------------|
| INT-01 | Hot condition | Set `sensor.Temperature = 300`, run until yield | `cooler.On = 1` (300 > 295) |
| INT-02 | Cold condition | Set `sensor.Temperature = 290`, run until yield | `cooler.On = 0` (290 < 295) |
| INT-03 | Boundary - exact | Set `sensor.Temperature = 295`, run until yield | `cooler.On = 0` (295 is NOT > 295) |
| INT-04 | Boundary - above | Set `sensor.Temperature = 295.1`, run until yield | `cooler.On = 1` |
| INT-05 | Loop behavior | Let run for multiple yields, change temp mid-run | Cooler responds to temperature changes |

**Test Script:**
```basic
DEVICE sensor "StructureGasSensor"
DEVICE cooler "StructureWallCooler"

VAR temp = 0

MainLoop:
    temp = sensor.Temperature
    IF temp > 295 THEN
        cooler.On = 1
    ELSE
        cooler.On = 0
    ENDIF
    YIELD
    GOTO MainLoop
```

---

### 3. Batch Mode Operations (Advanced)

| Test ID | Test Case | Steps | Expected Result |
|---------|-----------|-------|-----------------|
| BATCH-01 | Single device average | One sensor, read Temperature | Returns that sensor's value |
| BATCH-02 | Default mode is Average | Compile `temp = sensor.Temperature`, check IC10 | `lb rX HASH Temperature 0` (mode 0 = Average) |

**Note:** Multiple devices with same prefab hash require multiple DEVICE statements or manual pool setup. Basic single-device DEVICE statements test the core functionality.

---

### 4. Mixed Device Types (ALIAS + DEVICE)

| Test ID | Test Case | Steps | Expected Result |
|---------|-----------|-------|-----------------|
| MIX-01 | ALIAS d0 + DEVICE | Script uses both `ALIAS panel d0` and `DEVICE sensor "..."` | Both work correctly |
| MIX-02 | d0 direct + DEVICE | Script uses both `d0.Setting` and `sensor.Temperature` | Both resolve correctly |
| MIX-03 | Independence | Change d0.Temperature, check sensor.Temperature | Values are independent (different devices) |

**Test Script:**
```basic
ALIAS panel d0
DEVICE sensor "StructureGasSensor"

VAR panelSetting = 0
VAR sensorTemp = 0

MainLoop:
    panelSetting = panel.Setting
    sensorTemp = sensor.Temperature

    IF sensorTemp > panelSetting THEN
        d0.On = 1
    ELSE
        d0.On = 0
    ENDIF
    YIELD
    GOTO MainLoop
```

---

### 5. Simulator UI Verification

| Test ID | Test Case | Steps | Expected Result |
|---------|-----------|-------|-----------------|
| UI-01 | Device list shows named devices | Start simulator with DEVICE script | Named devices appear below d0-d5 |
| UI-02 | Edit named device properties | Click on sensor row, edit Temperature | Value updates, script uses new value |
| UI-03 | Alias column shows prefab | Look at Alias column for named device | Shows prefab name (e.g., "StructureGasSensor") |
| UI-04 | Device persistence across reset | Reset simulator, check device list | Named devices reappear (parsed from code) |

---

### 6. Error Handling

| Test ID | Test Case | Steps | Expected Result |
|---------|-----------|-------|-----------------|
| ERR-01 | Unknown property | Read `sensor.FakeProperty` | Returns 0 (no crash) |
| ERR-02 | No matching devices | lb with hash that has no devices in pool | Returns 0 (no crash) |

---

## Regression Tests

Verify these still work after changes:

| Test ID | Test Case | Expected Result |
|---------|-----------|-----------------|
| REG-01 | Pin device read (`d0.Temperature`) | Works as before |
| REG-02 | Pin device write (`d0.On = 1`) | Works as before |
| REG-03 | ALIAS statement (`ALIAS sensor d0`) | Works as before |
| REG-04 | Slot access (`d0.Slot[0].Quantity`) | Works as before |
| REG-05 | Wire removal (all 3 methods) | Still works |
| REG-06 | Comment node output | Still generates `# comment` |
| REG-07 | Dropdown visibility | Still shows selections |

---

## Pass/Fail Summary

| Category | Tests | Pass | Fail | Notes |
|----------|-------|------|------|-------|
| Basic DEVICE | 5 | | | |
| Integration | 5 | | | |
| Batch Modes | 2 | | | |
| Mixed Types | 3 | | | |
| Simulator UI | 4 | | | |
| Error Handling | 2 | | | |
| Regression | 7 | | | |
| **TOTAL** | **28** | | | |

---

## Quick Start Test

**Fastest way to verify the fix works:**

1. Open Basic-10 v3.0.15
2. Paste this code:
```basic
DEVICE sensor "StructureGasSensor"
VAR temp = 0
temp = sensor.Temperature
```
3. Compile (F5)
4. Open Simulator (F6)
5. In device list, find `sensor` row
6. Set `sensor.Temperature` to `999`
7. Click Step 3 times
8. Check `temp` register - should show `999`

If `temp` shows `999`, the fix is working!

---

**End of Test Plan**
