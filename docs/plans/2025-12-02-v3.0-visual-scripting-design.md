# Basic-10 v3.0 Design Document
# Visual Scripting Mode & Widget Dashboard

**Date:** 2025-12-02
**Version:** 3.0.0
**Author:** Dog Tired Studios + Claude

---

## Executive Summary

Version 3.0 introduces a visual scripting mode inspired by Stormworks' logic system, allowing users to create IC10 programs by connecting nodes on a canvas. This update also includes a customizable widget dashboard for monitoring variables, devices, and tasks during development and simulation.

### Goals
1. **Lower barrier to entry** - Help players intimidated by text coding
2. **Rapid prototyping** - Quick logic sketching before optimization
3. **Visualization tool** - Understand existing code as visual graphs
4. **Full replacement option** - Complete alternative to text-based coding

---

## Feature 1: Visual Scripting Mode

### 1.1 Canvas Implementation

**Technology:** WPF Native (Canvas + custom UserControls)

**Rationale:**
- Single tech stack with existing codebase
- Full control over retro theming
- Better long-term maintainability
- No JS↔C# bridge complexity

**Canvas Features:**
- Pan: Middle-mouse drag or Space+drag
- Zoom: Scroll wheel (10% - 400% range)
- Selection: Click to select, Ctrl+click multi-select, drag rectangle for box select
- Grid: Optional snap-to-grid (toggleable)
- Minimap: Optional overview panel for large graphs

### 1.2 Node Design

**Visual Style:** Minimal/Clean (Phase 1)
- Simple rectangles with rounded corners (8px radius)
- Header bar with node name and category icon
- Input pins on left, output pins on right
- Compact body with inline parameter editing
- Future: Retro theme option with CRT glow effects

**Node Structure:**
```
┌─────────────────────────┐
│ [icon] Node Name        │  ← Header (category color)
├─────────────────────────┤
│ ● Input1          Out ○ │  ← Pins with labels
│ ● Input2               │
│   [Parameter: ___]      │  ← Inline editing
└─────────────────────────┘
```

**Pin Types & Colors:**
| Type | Color | Description |
|------|-------|-------------|
| Execution | White | Program flow (IF, WHILE, GOTO) |
| Number | Blue (#4A9EFF) | Float/integer values |
| Boolean | Red/Green | Red=#FF4444 false, Green=#44FF44 true |
| Device | Orange (#FFA500) | Device references |
| String/Hash | Purple (#AA44FF) | Text and hash values |

### 1.3 Connection System

**Hybrid Approach:**
- **Data wires:** Connect outputs to inputs for value flow
- **Execution wires:** Only on flow control nodes (IF, WHILE, FOR, GOTO, GOSUB)

**Wire Rendering:**
- Bezier curves for smooth visual flow
- 2px stroke width (3px when hovered/selected)
- Type-based colors matching pin types

**Wire Animation (during simulation):**
- Pulse/particle flow showing data direction
- Particles travel along wire path
- Speed: ~100px/second
- Brightness pulse on value change
- Boolean wires flash on toggle

**Animation States:**
| State | Animation |
|-------|-----------|
| Editing | Static wires, no animation |
| Simulating | Continuous particle flow |
| Value Changed | Bright pulse travels along wire |
| Error | Red pulse, wire flashes |

### 1.4 Node Categories

**Devices**
- Pin Device (d0-d5)
- Named Device (DEVICE "PrefabName")
- THIS/db reference
- Slot Access

**Device I/O**
- Read Property
- Write Property
- Batch Read (BATCHREAD)
- Batch Write (BATCHWRITE)

**Variables**
- Variable (VAR)
- Constant (CONST/DEFINE)
- LET assignment
- Array (DIM)

**Math - Basic**
- Add (+)
- Subtract (-)
- Multiply (*)
- Divide (/)
- Modulo (MOD)
- Power (^)
- Negate (-)

**Math - Functions**
- ABS, SQRT, MIN, MAX
- CEIL, FLOOR, ROUND, TRUNC
- SGN, RND

**Trigonometry**
- SIN, COS, TAN
- ASIN, ACOS, ATAN, ATAN2

**Exponential**
- EXP, LOG

**Comparison**
- Equal (=, ==)
- Not Equal (<>, !=)
- Less Than (<)
- Greater Than (>)
- Less/Equal (<=)
- Greater/Equal (>=)

**Logical**
- AND (&&)
- OR (||)
- NOT (!)

**Bitwise**
- BAND (&)
- BOR (|)
- BXOR (^)
- BNOT (~)
- SHL (<<)
- SHR (>>)

**Compound Assignment**
- Add Assign (+=)
- Subtract Assign (-=)
- Multiply Assign (*=)
- Divide Assign (/=)

**Increment/Decrement**
- Pre-increment (++x)
- Post-increment (x++)
- Pre-decrement (--x)
- Post-decrement (x--)

**Flow Control - Conditional**
- IF/THEN/ELSE (with execution pins)
- SELECT CASE

**Flow Control - Loops**
- WHILE/WEND
- DO/LOOP UNTIL
- FOR/NEXT
- BREAK
- CONTINUE

**Flow Control - Jumps**
- Label
- GOTO
- GOSUB
- RETURN

**Subroutines**
- SUB definition
- FUNCTION definition
- CALL
- EXIT SUB/FUNCTION

**Timing**
- YIELD
- SLEEP/WAIT
- END

**Stack**
- PUSH
- POP
- PEEK

**Utility**
- Comment
- REM

### 1.5 Node Palette & Search

**Collapsible Sidebar Palette:**
- Left side of canvas (300px default width)
- Categorized tree view matching node categories above
- Drag-and-drop nodes onto canvas
- Collapse to icon strip (40px) for more canvas space
- Filter box at top for quick filtering

**Quick Search Popup:**
- Activated by Tab key or right-click on canvas
- Floating search box appears at cursor
- Type to filter all nodes
- Arrow keys to navigate, Enter to place
- Shows category path: "Math > Functions > ABS"

**Experience Mode Integration:**
| Mode | Palette Behavior |
|------|------------------|
| Beginner | Open by default, essential nodes only |
| Intermediate | Open, most nodes visible |
| Expert | Collapsed, all nodes available |
| Custom | User preference |

### 1.6 Code Generation Panel

**Layout:** Side-by-side with visual canvas (resizable splitter)

**Update Timing:** On action release (not every pixel drag)

**Features:**
- Read-only editor (AvalonEdit component)
- Syntax highlighting matching main editor
- Copy button (copies all generated code)
- Line counter: "BASIC: 45 lines | IC10: 67/128"
- Toggle button: BASIC ↔ IC10 view

**Bidirectional Highlight Sync:**
- Click node → Highlights corresponding BASIC lines (yellow background)
- Click BASIC line → Highlights source node (selection glow)
- Hover node → Dims code except relevant lines

**Code Generation Rules:**
- Comments indicate source node for debugging
- Consistent variable naming from node labels
- Optimized output (minimal register usage)
- Preserves user's node arrangement in generation order

### 1.7 Project File Structure

Each visual script is a folder:
```
MyScript/
├── script.bas          # Generated BASIC source
├── visual.json         # Node graph data
├── script.ic10         # Compiled IC10 output
└── instruction.xml     # Stationeers metadata (Title, Author, Description)
```

**visual.json Schema:**
```json
{
  "version": "3.0",
  "canvas": {
    "zoom": 1.0,
    "panX": 0,
    "panY": 0
  },
  "nodes": [
    {
      "id": "uuid-string",
      "type": "Math.Add",
      "x": 100,
      "y": 200,
      "parameters": {},
      "label": "Add Pressure"
    }
  ],
  "connections": [
    {
      "id": "uuid-string",
      "sourceNode": "node-uuid",
      "sourcePin": "output",
      "targetNode": "node-uuid",
      "targetPin": "inputA"
    }
  ],
  "metadata": {
    "experienceMode": "Intermediate",
    "created": "2025-12-02T10:00:00Z",
    "modified": "2025-12-02T15:30:00Z"
  }
}
```

---

## Feature 2: Experience Modes

### 2.1 Mode Definitions

**Beginner Mode**
- Node labels: Friendly ("Turn On Light", "Read Temperature")
- Code panel: Hidden by default
- Available nodes: Essential subset only
- Wiring: Auto-typed, simple validation messages
- Errors: Plain English ("The sensor isn't connected to anything")

**Intermediate Mode**
- Node labels: Mixed ("Set device.On = 1")
- Code panel: Shows BASIC
- Available nodes: Most nodes
- Wiring: Shows data types on hover
- Errors: BASIC line references

**Expert Mode**
- Node labels: Technical ("s d0 On 1")
- Code panel: Shows BASIC + IC10 toggle
- Available nodes: All nodes including advanced
- Wiring: Shows types + register allocation hints
- Errors: IC10 line + optimization suggestions

**Custom Mode**
- All settings user-configurable
- Toggle each feature independently
- Save/load custom presets

### 2.2 Mode Switching

- Dropdown in toolbar: [Beginner ▼]
- Instant switch, preserves graph
- Nodes re-render with appropriate labels
- Code panel shows/hides based on mode

---

## Feature 3: Widget Dashboard

### 3.1 Window Behavior

**Type:** Separate pop-out window
- Always-on-top toggle
- Remember position/size
- Minimize to system tray option
- Keyboard shortcut to show/hide (F12)

### 3.2 Available Widgets (v3.0)

**Task Checklist**
- User-defined TODO items
- Checkbox for completion
- Add/edit/delete/reorder items
- Optional priority levels
- Persists in project folder

**Variable Watch**
- Add BASIC variables to watch
- Shows current value during simulation
- Highlight on value change
- Edit values during pause

**Device Monitor**
- Select devices (by alias or pin)
- Shows key properties (On, Setting, Temperature, Pressure)
- Live updates during simulation
- Click to jump to device node

**Register View**
- All 18 registers (r0-r15, sp, ra)
- Live values during simulation
- Hex/decimal toggle
- Highlight modified registers

**Line Counter**
- BASIC line count
- IC10 line count
- Progress bar to 128 limit
- Warning at 100+ lines

**Console Output**
- Compilation messages
- Simulation debug output
- Error/warning log
- Clear button, copy button

### 3.3 Widget Layout

**Grid System:**
- Dashboard divided into cells
- Widgets snap to grid
- Resize by dragging edges
- Minimum size per widget type

**Layout Persistence:**
- Global default layout (user preference)
- Per-project layout override (stored in project folder)
- Import/export layout presets

### 3.4 Future Widgets (Post-3.0)

- Simulated LED Display (shows Color value)
- Simulated Dial/Gauge (shows Setting value)
- Value Graph (plot value over time)
- Breakpoint List
- Call Stack View

---

## Implementation Phases

### Phase 1: Foundation (Can run in parallel: A, B, C)

**1A: Canvas Infrastructure** [No dependencies]
- WPF Canvas setup with pan/zoom
- Grid rendering
- Selection system (click, box select)
- Undo/redo framework

**1B: Node System** [No dependencies]
- Base Node class and rendering
- Pin definitions and hit testing
- Node parameter editing
- Node serialization (JSON)

**1C: Widget Dashboard Window** [No dependencies]
- Pop-out window framework
- Widget base class
- Grid layout system
- Layout save/load

### Phase 2: Connections (Depends on 1A, 1B)

**2A: Wire System** [Depends on 1A, 1B]
- Bezier curve rendering
- Connection creation (drag from pin)
- Connection validation (type checking)
- Wire serialization

**2B: Basic Widgets** [Depends on 1C]
- Task Checklist widget
- Console Output widget
- Line Counter widget

### Phase 3: Core Nodes (Depends on 1B)

**3A: Variable & Math Nodes** [Depends on 1B]
- VAR, CONST, DEFINE nodes
- Basic math operators
- Math functions

**3B: Device Nodes** [Depends on 1B]
- Pin device nodes (d0-d5)
- Named device nodes
- Read/Write property nodes
- Batch operations

**3C: Simulation Widgets** [Depends on 2B]
- Variable Watch widget
- Device Monitor widget
- Register View widget

### Phase 4: Code Generation (Depends on 2A, 3A, 3B)

**4A: BASIC Generator** [Depends on 2A, 3A, 3B]
- Graph traversal algorithm
- BASIC code emission
- Node-to-line mapping for sync

**4B: Code Panel Integration** [Depends on 4A]
- Side-by-side layout
- Bidirectional highlight sync
- BASIC/IC10 toggle

### Phase 5: Flow Control (Depends on 4A)

**5A: Flow Control Nodes** [Depends on 4A]
- IF/THEN/ELSE with execution pins
- WHILE/WEND, FOR/NEXT
- GOTO, GOSUB, RETURN
- BREAK, CONTINUE

**5B: Subroutine Nodes** [Depends on 5A]
- SUB/END SUB
- FUNCTION/END FUNCTION
- CALL node

### Phase 6: Experience Modes (Depends on 4B)

**6A: Mode System** [Depends on 4B]
- Mode switching infrastructure
- Node label variants
- Palette filtering by mode
- UI state per mode

**6B: Custom Mode** [Depends on 6A]
- Settings UI for customization
- Preset save/load

### Phase 7: Animation & Polish (Depends on 2A, 3C)

**7A: Wire Animation** [Depends on 2A]
- Particle system for wires
- Flow direction animation
- Value change pulses

**7B: Simulation Integration** [Depends on 3C, 7A]
- Connect to existing simulator
- Live value updates in widgets
- Animated wires during simulation

### Phase 8: Project Management (Depends on 4A)

**8A: Folder-Based Projects** [Depends on 4A]
- Project folder structure
- visual.json save/load
- Integration with existing .bas workflow

**8B: Migration Tools** [Depends on 8A]
- Import existing .bas to visual (future)
- Template projects

---

## Dependency Graph

```
Phase 1 (Parallel):
  1A Canvas ─────┐
  1B Nodes ──────┼──→ Phase 2A Wires ──→ Phase 4A Generator ──→ Phase 5 Flow Control
  1C Dashboard ──┼──→ Phase 2B Widgets ──→ Phase 3C Sim Widgets    │
                 │                                                  │
                 └──→ Phase 3A Math Nodes ─────────────────────────┘
                 └──→ Phase 3B Device Nodes ───────────────────────┘
                                                                    │
Phase 4B Code Panel ←──────────────────────────────────────────────┘
         │
         └──→ Phase 6 Experience Modes ──→ Phase 6B Custom Mode

Phase 7 Animation (after 2A, 3C)
Phase 8 Project Mgmt (after 4A)
```

**Maximum Parallelization:**
- Start: 1A, 1B, 1C (3 parallel agents)
- After Phase 1: 2A, 2B, 3A, 3B (4 parallel agents)
- After Phase 2: 3C, 4A can start
- Continue as dependencies resolve

---

## Technical Notes

### Performance Considerations
- Canvas virtualization for large graphs (100+ nodes)
- Wire rendering optimization (batch draw calls)
- Lazy node parameter evaluation
- Background thread for code generation

### Accessibility
- Keyboard navigation between nodes
- Screen reader support for node descriptions
- High contrast mode compatibility
- Configurable animation speed (or disable)

### Testing Strategy
- Unit tests for code generation (node → BASIC)
- Integration tests for graph serialization
- UI automation tests for canvas interactions
- Performance benchmarks for large graphs

---

## Success Criteria

1. User can create a working IC10 script entirely in visual mode
2. Generated BASIC code is readable and matches manual coding style
3. Mode switching is instant with no data loss
4. Widget dashboard provides useful simulation feedback
5. Performance remains smooth with 50+ nodes
6. Existing text-mode users are not disrupted

---

## Timeline Estimate

With parallel agent execution:
- **Phase 1:** Foundation (1A, 1B, 1C parallel)
- **Phase 2-3:** Core systems (2A, 2B, 3A, 3B, 3C with dependencies)
- **Phase 4-5:** Code generation and flow control
- **Phase 6-7:** Polish and modes
- **Phase 8:** Project management

Total estimated implementation phases: 8 phases with significant parallelization opportunity.

---

*Document generated during brainstorming session - 2025-12-02*
