# Visual Graph to BASIC Code Generator

## Overview

This directory contains the code generation system for Phase 4A of the Basic-10 Visual Scripting feature. It converts a visual node graph into clean, readable BASIC source code with full source mapping support.

## Architecture

### Core Components

#### 1. **GraphToBasicGenerator.cs** - Main Generator
The primary entry point for code generation.

**Usage:**
```csharp
var nodes = new List<NodeBase>(); // Your visual nodes
var wires = new List<Wire>();     // Connections between nodes

var generator = new GraphToBasicGenerator(nodes, wires);
var (code, sourceMap) = generator.GenerateWithSourceMap();

// Check for errors
if (!generator.IsSuccessful)
{
    var errors = generator.GetErrors();
    var warnings = generator.GetWarnings();
}
```

**Features:**
- Generates code in logical sections (Variables, Constants, Devices, Arrays, Main)
- Handles all node types (variables, devices, math, logic, etc.)
- Tracks which nodes have been processed to avoid duplication
- Provides source mapping for bidirectional highlighting

#### 2. **ExecutionOrderResolver.cs** - Topological Sorting
Determines the correct order to execute nodes based on execution flow and data dependencies.

**Key Methods:**
- `ResolveExecutionOrder()` - Returns execution chains (sequences of nodes)
- `TopologicalSortForNode()` - Sorts data dependencies for a specific node
- `GetDataDependencies()` - Gets all nodes that feed data to a pin
- Detects cycles in both execution flow and data flow

**Algorithm:**
1. Find entry points (nodes with no execution input)
2. Follow execution wires to build chains
3. For data nodes, perform topological sort based on data dependencies
4. Report errors for any cycles detected

#### 3. **ExpressionBuilder.cs** - Expression Construction
Builds BASIC expressions from connected data nodes.

**Features:**
- Handles operator precedence (uses parentheses for safety)
- Supports binary operators (+, -, *, /, %, ^)
- Supports unary operators (-, NOT)
- Supports function calls (ABS, SQRT, etc.)
- Supports comparison operators (=, <>, <, >, <=, >=)
- Handles device property access (device.Property)
- Handles array access (array[index])
- Caches expressions to avoid duplicate work

**Expression Types:**
```csharp
// Simple expressions (inlined)
"a"              // Variable
"5"              // Constant
"a + b"          // Binary operation

// Complex expressions (may use temp variables)
"((a + b) * (c - d))"  // Nested operations
"ABS(temperature)"      // Function calls
"pump.Temperature"      // Property access
```

#### 4. **CodeGenerationContext.cs** - State Tracking
Maintains state during code generation.

**Properties:**
- `Lines` - Generated code lines
- `SourceMap` - Line-to-node mapping
- `IndentLevel` - Current indentation level
- `TempVariableCounter` - For generating unique temp variable names
- `NodeVariableNames` - Maps nodes to their assigned variable names
- `DeclaredVariables` - Tracks declared variables (prevents duplicates)
- `ProcessedNodes` - Tracks which nodes have been generated
- `Errors` / `Warnings` - Collected diagnostics

**Methods:**
- `AddLine(nodeId, line)` - Add a line with source mapping
- `AddSectionHeader(name)` - Add a commented section header
- `GetTempVariable()` - Generate unique temp variable name
- `AddError()` / `AddWarning()` - Record diagnostics

#### 5. **SourceMap.cs** - Bidirectional Mapping
Maps between generated code lines and visual nodes.

**Features:**
- `NodeToLines` - Maps node IDs to line numbers they generated
- `LineToNode` - Maps line numbers to the node that generated them
- `LineContent` - Stores line content for debugging
- Enables bidirectional highlighting sync between code view and graph view

**Usage:**
```csharp
// Get lines generated by a node
var lines = sourceMap.GetLinesForNode(nodeId);

// Get node that generated a line
var nodeId = sourceMap.GetNodeForLine(lineNumber);

// Get line range for a node
var (minLine, maxLine) = sourceMap.GetLineRangeForNode(nodeId);
```

#### 6. **GeneratedCodeOptimizer.cs** - Code Optimization
Performs basic optimizations on generated code.

**Optimizations:**
- Remove unused temp variables
- Remove consecutive duplicate assignments (x = 1; x = 2; → x = 2;)
- Remove dead code (unreachable after GOTO, RETURN, END)
- Remove excessive blank lines (max 2 consecutive)
- Combine arithmetic operations (x += 1; x += 2; → x += 3;)

**Usage:**
```csharp
var optimizer = new GeneratedCodeOptimizer(context);
string optimizedCode = optimizer.Optimize(rawCode);
```

## Code Generation Rules

### Variables
```basic
' Declaration with initial value
VAR counter = 0

' Declaration without initial value
VAR temp

' Assignment (not generated as separate statement in current implementation)
LET counter = 5
```

### Constants
```basic
' Named constant
CONST MAX_TEMP = 100

' Preprocessor define
DEFINE HASH_PUMP -1234567
```

### Devices
```basic
' Pin device (d0-d5)
ALIAS pump d0

' Named device (bypasses 6-pin limit)
DEVICE furnace "StructureFurnace"

' This device (IC chip itself)
ALIAS chip db
```

### Arrays
```basic
' Array declaration
DIM temperatures(10)

' Array access (as expression)
temp = temperatures[i]

' Array assignment
temperatures[i] = 25
```

### Math Operations
```basic
' Binary operations
result = a + b
result = a - b
result = a * b
result = a / b
result = a % b  ' Modulo
result = a ^ b  ' Power

' Unary operations
result = -value
result = ABS(value)
result = SQRT(value)
```

### Device Operations
```basic
' Read property
temp = pump.Temperature

' Write property
pump.On = 1
pump.Setting = 50
```

### Logic Operations
```basic
' Comparisons
IF temp > 100 THEN
    ' ...
ENDIF

' Boolean operations
result = (a > b) AND (c < d)
result = (x = 0) OR (y = 0)
result = NOT flag
```

### Compound Assignments
```basic
counter += 1
counter -= 1
counter *= 2
counter /= 2
```

### Increment/Decrement
```basic
' Postfix
counter++
counter--

' Prefix
++counter
--counter
```

## Error Handling

The code generator reports errors and warnings through the context:

**Common Errors:**
- Unconnected required inputs
- Type mismatches (detected by Wire validation)
- Cycles in data flow
- Invalid variable/constant names
- Missing device connections

**Common Warnings:**
- Duplicate variable declarations
- Missing YIELD in loops (would auto-insert)
- No entry points in graph

**Error Reporting:**
```csharp
var generator = new GraphToBasicGenerator(nodes, wires);
var code = generator.Generate();

if (!generator.IsSuccessful)
{
    foreach (var error in generator.GetErrors())
    {
        Console.WriteLine($"Error in node {error.NodeId}: {error.Message}");
    }
}

foreach (var warning in generator.GetWarnings())
{
    Console.WriteLine($"Warning in node {warning.NodeId}: {warning.Message}");
}
```

## Code Style

The generator produces clean, readable BASIC code:

- **Section headers** with comments (`' --- Variables ---`)
- **4-space indentation** for nested blocks
- **Blank lines** between logical sections
- **Meaningful comments** for complex operations
- **Consistent formatting** throughout

**Example Output:**
```basic

' --- Variables ---
VAR counter = 0
VAR temperature
VAR result

' --- Constants ---
CONST MAX_TEMP = 100

' --- Devices ---
ALIAS pump d0
DEVICE furnace "StructureFurnace"

' --- Main ---
temperature = pump.Temperature
IF temperature > MAX_TEMP THEN
    pump.On = 0
ENDIF
counter++
```

## Examples

See `CodeGeneratorExample.cs` for working examples:

1. **Simple Example** - Variable declaration and increment
2. **Device Example** - Device alias and property reading
3. **Math Example** - Variable declarations and arithmetic operations

**Running Examples:**
```csharp
using BasicToMips.UI.VisualScripting.CodeGen;

CodeGeneratorExample.RunAllExamples();
```

## Future Enhancements

Planned features for future phases:

1. **Flow Control Nodes**
   - IF/THEN/ELSE statements
   - WHILE/WEND loops
   - FOR loops
   - GOTO and labels

2. **Expression Optimization**
   - Constant folding (5 + 3 → 8)
   - Common subexpression elimination
   - Dead code elimination in expressions

3. **Smart Temp Variable Usage**
   - Only generate temps for complex expressions
   - Inline simple expressions
   - Reuse temp variables where safe

4. **Better Error Messages**
   - Suggest fixes for common errors
   - Show node names in error messages
   - Highlight problematic connections

5. **Code Formatting Options**
   - Configurable indentation
   - Comment styles
   - Line length limits

## Testing

The code generation system includes:
- Example graphs that demonstrate various features
- Error detection and reporting
- Source map validation

**Manual Testing:**
1. Create a visual graph in the editor
2. Call `GraphToBasicGenerator.Generate()`
3. Verify generated code compiles
4. Verify source map is accurate

**Automated Testing:**
Use the examples in `CodeGeneratorExample.cs` as unit test templates.

## Integration Points

### With Visual Editor
- Call generator when user clicks "Generate Code" button
- Display generated code in side panel or modal
- Use source map for bidirectional highlighting

### With BASIC Compiler
- Generated code should pass directly to existing BASIC compiler
- No manual editing required
- Should produce valid IC10 assembly

### With Source Map
- When user clicks on generated code line, highlight corresponding node
- When user selects node, highlight corresponding code lines
- Enable debugging by mapping runtime errors back to nodes

## Performance Considerations

- **Node Count**: Handles graphs with 100s of nodes efficiently
- **Wire Count**: Topological sort is O(V + E) where V=nodes, E=wires
- **Expression Building**: Cached to avoid rebuilding same expressions
- **Memory**: Source map stores all mappings in memory (negligible for typical graphs)

## Limitations

Current limitations (to be addressed in future phases):

1. No flow control statements yet (IF, WHILE, FOR)
2. No subroutines/functions
3. No label generation for GOTO statements
4. Limited optimization (basic only)
5. No code formatting options
6. Expression precedence uses conservative parentheses

## Contributing

When adding new node types:

1. Add code generation method in `GraphToBasicGenerator.cs`
2. Add expression building in `ExpressionBuilder.cs` if node produces values
3. Update this README with new node type examples
4. Add test case in `CodeGeneratorExample.cs`

## Summary

This code generation system provides a solid foundation for converting visual graphs to BASIC code. It handles:

- All major node types (variables, constants, devices, math, logic)
- Expression building with proper precedence
- Topological sorting for correct execution order
- Source mapping for debugging
- Error detection and reporting
- Basic code optimization

The architecture is extensible and ready for future enhancements like flow control, subroutines, and advanced optimizations.
